<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>COMP4321 - Search Engine</title>
		<link rel="stylesheet" href="css/main.css" media="screen" title="Main CSS" charset="utf-8">
	</head>
	<body>
		<form id='queryForm' data-layer='1'>
			<input id='query' type="text" autocomplete="off" autofocus list=suggestedWords>
			<datalist id="suggestedWords"></datalist>
			<audio id='soundEffect' controls='false' preload>
				<source src="assets/submitQuery.mp3" type="audio/mpeg">
			</audio>
		</form>
		<div id="results">
		</div>
		<div id="pagination">
		</div>

		<template id="resultTemplate">
			<div class="resultItem">
				<a class='header' href='#'>
					<div class="favIcon"></div>
					<div class="pageTitle"></div>
				</a>
				<div class="pageInfo">
					<div class="lastModifiedDate"></div>
					<div class="url"></div>
				</div>
			</div>
		</template>
		<template id="pageBtnTemplate">
			<div class="pageBtn">
			</div>
		</template>

		<script>
			// ----------------
			// GLOBAL VARAIBLES
			// ----------------
			var query = {
				DOM: document.getElementById('query'),
				formDOM: document.getElementById('queryForm'),
				suggestedWordDOM: document.getElementById('suggestedWords'),
				sound: document.getElementById('soundEffect')
			};
			var result = {
				DOM: document.getElementById('results'),
				template: document.getElementById('resultTemplate').content,
				paginationDOM: document.getElementById('pagination'),
				pageinationTemplate: document.getElementById('pageBtnTemplate').content
			}

			// -------------------
			// HELPER FUNCTIONS
			// -------------------
			var buildGetRequest = (JSONReq) => {
				return Object.keys(JSONReq).map((key) => {
					return `${encodeURIComponent(key)}=${encodeURIComponent(JSONReq[key])}`;
				}).join('&');
			}

			var emptyChildren = (e) => {
				while(e.lastElementChild) {
					e.removeChild(e.lastElementChild);
				}
			}

			// --------------
			// CORE FUNCTIONS
			// --------------

			// FORM RELATED -----------
			query.formDOM.onsubmit = (e) => {e.preventDefault();}
			query.submit = () => {
				return new Promise((resolve, reject) => {
					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = () => {
						if (xhttp.readyState === 4 && xhttp.status === 200)
							resolve(JSON.parse(xhttp.response));
					}
					xhttp.open('get', `/query?${buildGetRequest({
						s: query.DOM.value
					})}`, true);
					xhttp.send();
				});
			}
			query.suggest = (query) => {
				query?query:query.DOM.value;
				return new Promise((resolve, reject) => {
					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = () => {
						if (xhttp.readyState === 4 && xhttp.status === 200)
							resolve(JSON.parse(xhttp.response));
					}
					xhttp.open('get', `/word?${buildGetRequest({
						s: query
					})}`, true);
					xhttp.send();
				});
			}

			// RESULT RELATED -----------
			result.buildDOM = (res) => {
				if (!res.data.length) {
					result.DOM.innerHTML =
					`<div id="noResultMsg">
						<h2>Sorry, no webpage matches</h2>
					</div>`;
					emptyChildren(result.paginationDOM);
				} else {
					// build results div
					result.DOM.innerHTML = "";
					res.data.forEach((datum) => {
						var entry = document.importNode(result.template, true);
						if (datum.favIconUrl.length) {
							entry.querySelector('.favIcon').innerHTML = `<img src='${datum.favIconUrl}'/>`;
						} else {
							entry.querySelector('.favIcon').textContent = datum.title.substr(0, 1);
						}
						entry.querySelector('.pageTitle').textContent = datum.title;
						entry.querySelector('.lastModifiedDate').textContent = (new Date(datum.lastModifiedDate)).toDateString();
						entry.querySelector('.url').textContent = datum.url;

						entry.querySelector('a.header').setAttribute('href', datum.url);
						entry.querySelector('a.header').setAttribute('target', '_blank');
						result.DOM.appendChild(entry);
					})

					// build pageination buttons
					emptyChildren(result.paginationDOM);
					var numPages = parseInt(res.querySummary.resultsCnt / 10) + 1;
					var pageBtn = document.importNode(result.pageinationTemplate, true);
					pageBtn.querySelector('.pageBtn').textContent = 1;
					pageBtn.querySelector('.pageBtn').classList.add('active');
					result.paginationDOM.appendChild(pageBtn);
					for (var i = 2; i <= numPages; i++) {
						pageBtn = document.importNode(result.pageinationTemplate, true);
						pageBtn.querySelector('.pageBtn').textContent = i;
						result.paginationDOM.appendChild(pageBtn);
					}
				}
			} // end:: buildBOM

			// KEY LISTENER -------------
			var keyPressTimeBuffer;
			document.onkeyup = (e) => {
				query.DOM.focus();
				result.DOM.classList.add('typing');
				query.formDOM.classList.remove('fadedOut');
				switch (e.keyCode) {
					case 27: // esc key
						query.formDOM.classList.add('fadedOut');
						result.DOM.classList.remove('typing');
						break;
					case 13: // enter key
						emptyChildren(query.suggestedWordDOM);
						// animate input box
						query.DOM.classList.add('shrinkToLoadingBar');
						query.sound.play();
						// submit form
						query.submit()
						.then((response) => {
							result.buildDOM(response);
							query.DOM.classList.remove('shrinkToLoadingBar');
							query.formDOM.classList.add('fadedOut');
							result.DOM.classList.remove('typing');
						});
						break;
					default: // other keys
						if (query.DOM.value.length+1 <= 3) break; // +1 for the delay
						clearTimeout(keyPressTimeBuffer);
						keyPressTimeBuffer = setTimeout(() => {
							query.suggest(query.DOM.value)
							.then((suggestedWords) => {
								var wordOption;
								emptyChildren(query.suggestedWordDOM);
								if (!query.formDOM.classList.contains('fadedOut')) {
									suggestedWords.forEach((word) => {
										wordOption = document.createElement('option');
										wordOption.value = word;
										query.suggestedWordDOM.appendChild(wordOption)
									})
								}
							})
						}, 1000);
						break;
				}
			}
		</script>
	</body>
</html>
